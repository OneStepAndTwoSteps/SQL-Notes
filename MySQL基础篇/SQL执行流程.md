## SQL执行流程


### Oracle中SQL的执行流程


*   <div align=center><img width="700" height="350" src="https://raw.githubusercontent.com/OneStepAndTwoSteps/SQL-Notes/master/static/SQL%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/1.png"/></div>

*   __1、语法检查：__ 检查 SQL 拼写是否正确，如果不正确，Oracle 会报语法错误。

*   __2、语义检查：__ 检查 SQL 中的访问对象是否存在。比如我们在写 SELECT 语句的时候，列名写错了，系统就会提示错误。语法检查和语义检查的作用是保证 SQL 语句没有错误。

*   __3、权限检查：__ 看用户是否具备访问该数据的权限。

*   __4、共享池检查：__ 共享池（Shared Pool）是一块内存池，最主要的作用是缓存 SQL 语句和该语句的执行计划。Oracle 通过检查共享池是否存在 SQL 语句的执行计划，来判断进行软解析，还是硬解析。那软解析和硬解析又该怎么理解呢？在共享池中，Oracle 首先对 SQL 语句进行 Hash 运算，然后根据 Hash 值在库缓存（Library Cache）中查找，如果存在 SQL 语句的执行计划，就直接拿来执行，直接进入“执行器”的环节，这就是软解析。如果没有找到 SQL 语句和执行计划，Oracle 就需要创建解析树进行解析，生成执行计划，进入“优化器”这个步骤，这就是硬解析。

*   __5、优化器：__ 优化器中就是要进行硬解析，也就是决定怎么做，比如创建解析树，生成执行计划。

*   __6、执行器：__ 当有了解析树和执行计划之后，就知道了 SQL 该怎么被执行，这样就可以在执行器中执行语句了。


*   __补充:__ 共享池是 Oracle 中的术语，包括了库缓存，数据字典缓冲区等。我们上面已经讲到了库缓存区，它主要缓存 SQL 语句和执行计划。而数据字典缓冲区存储的是 Oracle 中的对象定义，比如表、视图、索引等对象。当对 SQL 语句进行解析的时候，如果需要相关的数据，会从数据字典缓冲区中提取。

*   库缓存这一个步骤，决定了 SQL 语句是否需要进行硬解析。为了提升 SQL 的执行效率，我们应该尽量避免硬解析，因为在 SQL 的执行过程中，创建解析树，生成执行计划是很消耗资源的。


__如何避免硬解析，尽量使用软解析呢？__ 如使用绑定变量 

在 Oracle 中，绑定变量是它的一大特色。绑定变量就是在 SQL 语句中使用变量，通过不同的变量取值来改变 SQL 的执行结果。这样做的好处是能提升软解析的可能性，不足之处在于可能会导致生成的执行计划不够优化，因此是否需要绑定变量还需要视情况而定。

*   普通的查询语句：

    SQL> select * from player where player_id = 10001;

*   使用绑定变量的查询语句：

    SQL> select * from player where player_id = :player_id;


这两个查询语句的效率在 Oracle 中是完全不同的。如果你在查询 player_id = 10001 之后，还会查询 10002、10003 之类的数据，那么每一次查询都会创建一个新的查询解析。而第二种方式使用了绑定变量，那么在第一次查询之后，在共享池中就会存在这类查询的执行计划，也就是软解析。

__使用绑定变量的优缺点：__

*   1、可以通过使用绑定变量来减少硬解析，减少 Oracle 的解析工作量。因为我们之前已经执行过了这个语句，也已经创建好了解析树，下次再执行的时候我们只要改变一下变量的值，我们基于可以跳过优化器直接执行执行器。

*   2、使用动态 SQL 的方式，因为参数不同(因为我们可能会改变绑定变量的值，比如 player_id=1000此时我们的player_id绑定变量值发生了改变)，会导致 SQL 的执行效率不同，同时 SQL 优化也会比较困难。



### MySQL中SQL的执行流程

__MySQL是C/S架构，整体架构由三部分组成：__

<div align=center><img width="700" height="400" src="https://raw.githubusercontent.com/OneStepAndTwoSteps/SQL-Notes/master/static/SQL%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/2.png"/></div>

*   1、连接层：客户端和服务器端建立连接，客户端发送 SQL 至服务器端；

*   2、SQL 层：对 SQL 语句进行查询处理；

*   3、存储引擎层：与数据库文件打交道，负责数据的存储和读取。



__SQL层:__

<div align=center><img width="450" height="500" src="https://github.com/OneStepAndTwoSteps/SQL_is_important/blob/master/static/SQL%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/3.jpg"/></div>


*   __1、查询缓存：__ Server 如果在查询缓存中发现了这条 SQL 语句，就会直接将结果返回给客户端；如果没有，就进入到解析器阶段。需要说明的是，因为查询缓存往往效率不高，所以在 MySQL8.0 之后就抛弃了这个功能。

*   __2、解析器：__ 在解析器中对 SQL 语句进行语法分析、语义分析。

*   __3、优化器：__ 在优化器中会确定 SQL 语句的执行路径，比如是根据全表检索，还是根据索引来检索等。

*   __4、执行器：__ 在执行之前需要判断该用户是否具备权限，如果具备权限就执行 SQL 查询并返回结果。在 MySQL8.0 以下的版本，如果设置了查询缓存，这时会将查询结果进行缓存。



### 总结

*   __Oracle：__ 共享池的概念，通过共享池来判断是进行软解析，还是硬解析。可以通过绑定变量来避免一定的硬解析。

*   __MySQL：__  8.0以前执行流程 SQL语句→查询缓存→解析器→优化器→执行器。 8.0 版本之后，MySQL 不再支持缓存的查询，一旦数据表有更新，缓存都将清空，原因是只有数据表是静态的时候，或者数据表很少发生变化时，使用缓存查询才有价值，否则如果数据表经常更新，反而增加了 SQL 的查询时间。所以执行流程变为 执行解析器→优化器→执行器。




