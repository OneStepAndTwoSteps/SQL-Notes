## 子查询

SQL 的子查询，也就是嵌套在查询中的查询。通过子查询我们可以进行更复杂的查询，因为很多时候，我们无法直接从数据表中得到查询结果，需要从查询结果集中再次进行查询，才能得到想要的结果。这个“查询结果集”就是今天我们要讲的子查询。


### 关联子查询和非关联子查询

__子查询可以分为关联子查询和非关联子查询。__

__关联子查询：__ 同样，如果子查询需要执行多次，即采用循环的方式，先从外部查询开始，每次都传入子查询进行查询，然后再将结果反馈给外部，这种 __嵌套的执行方式__ 就称为关联子查询。


__非关联子查询：__ 子查询从数据表中查询了数据结果，如果这个数据结果只执行一次，然后这个数据结果作为主查询的条件进行执行，那么这样的子查询叫做非关联子查询。


### 通过例子说明关联子查询和非关联子查询

现在我们有五张表 - 《[数据集所在位置](https://github.com/OneStepAndTwoSteps/SQL-Notes/tree/master/%E6%95%B0%E6%8D%AE%E9%9B%86sql/sql_nba_data-master/)》

    height_grades.sql   球员身高等级表
    team_score.sql      球队得分表
    team.sql            球队表
    player_score.sql    球员比赛成绩表
    player.sql          球员表

__非关联子查询：__

我们以 NBA 球员数据表为例，假设我们想要知道哪个球员的身高最高，最高身高是多少，就可以采用子查询的方式：

    SQL: SELECT player_name, height FROM player WHERE height = (SELECT max(height) FROM player)

__out:__

    +---------------+--------+
    | player_name   | height |
    +---------------+--------+
    | 索恩-马克     |   2.16 |
    +---------------+--------+
    1 row in set (0.00 sec)



这里我们通过SELECT max(height) FROM player可以得到最高身高这个数值，结果为 2.16，然后我们再通过 player 这个表，看谁具有这个身高，再进行输出，这样的子查询就是非关联子查询。(通过数据结果作为主查询的条件进行执行)



__关联子查询：__


如果子查询的执行依赖于外部查询，通常情况下都是因为子查询中的表 __用到了外部的表，并进行了条件关联__，因此 __每执行一次外部查询，子查询都要重新计算一次__，这样的子查询就称之为关联子查询。比如我们想要查找每个球队中大于平均身高的球员有哪些，并显示他们的球员姓名、身高以及所在球队 ID。

首先我们需要统计球队的平均身高，即SELECT avg(height) FROM player AS b WHERE a.team_id = b.team_id，然后筛选身高大于这个数值的球员姓名、身高和球队 ID，即：

    SELECT player_name, height, team_id FROM player AS a WHERE height > (SELECT avg(height) FROM player AS b WHERE a.team_id = b.team_id)
 

__out：__

    +------------------------------------+--------+---------+
    | player_name                        | height | team_id |
    +------------------------------------+--------+---------+
    | 安德烈-德拉蒙德                    |   2.11 |    1001 |
    | 索恩-马克                          |   2.16 |    1001 |
    | 扎扎-帕楚里亚                      |   2.11 |    1001 |
    | 乔恩-洛伊尔                        |   2.08 |    1001 |
    | 布雷克-格里芬                      |   2.08 |    1001 |
    | 雷吉-巴洛克                        |   2.01 |    1001 |
    | 斯坦利-约翰逊                      |   2.01 |    1001 |
    | 亨利-埃伦森                        |   2.11 |    1001 |
    | 斯维亚托斯拉夫-米凯卢克            |   2.03 |    1001 |
    | 博扬-博格达诺维奇                  |   2.03 |    1002 |
    | 多曼塔斯-萨博尼斯                  |   2.11 |    1002 |
    | 迈尔斯-特纳                        |   2.11 |    1002 |
    | 赛迪斯-杨                          |   2.03 |    1002 |
    | 道格-迈克德莫特                    |   2.03 |    1002 |
    | TJ-利夫                            |   2.08 |    1002 |
    | 凯尔-奥奎因                        |   2.08 |    1002 |
    | 阿利兹-约翰逊                      |   2.06 |    1002 |
    | 伊凯·阿尼博古                      |   2.08 |    1002 |
    +------------------------------------+--------+---------+
    18 rows in set (0.00 sec)


### EXISTS 子查询

__关联子查询通常也会和 EXISTS 一起来使用，EXISTS 子查询用来判断条件是否满足，满足的话为 True，不满足为 False。__


现在我们想要看出场过的球员都有哪些，并且显示他们的姓名、球员 ID 和球队 ID。在这个统计中，是否出场是通过 player_score 这张表中的球员出场表现来统计的，如果某个球员在 player_score 中有出场记录则代表他出场过，这里就使用到了 EXISTS 子查询，即EXISTS (SELECT player_id FROM player_score WHERE player.player_id = player_score.player_id)，然后将它作为筛选的条件，实际上也是关联子查询，即：

    SQL：SELECT player_id,player_name,team_id FROM player AS a WHERE EXISTS (SELECT player_id FROM player_score AS b WHERE a.player_id=b.player_id  );

__out:__

    +-----------+---------------------------+---------+
    | player_id | player_name               | team_id |
    +-----------+---------------------------+---------+
    |     10001 | 韦恩-艾灵顿               |    1001 |
    |     10002 | 雷吉-杰克逊               |    1001 |
    |     10003 | 安德烈-德拉蒙德           |    1001 |
    |     10004 | 索恩-马克                 |    1001 |
    |     10005 | 布鲁斯-布朗               |    1001 |
    |     10006 | 兰斯顿-加洛韦             |    1001 |
    |     10007 | 格伦-罗宾逊三世           |    1001 |
    |     10008 | 伊斯梅尔-史密斯           |    1001 |
    |     10009 | 扎扎-帕楚里亚             |    1001 |
    |     10010 | 乔恩-洛伊尔               |    1001 |
    |     10022 | 博扬-博格达诺维奇         |    1002 |
    |     10023 | 多曼塔斯-萨博尼斯         |    1002 |
    |     10024 | 迈尔斯-特纳               |    1002 |
    |     10025 | 赛迪斯-杨                 |    1002 |
    |     10028 | 泰瑞克-埃文斯             |    1002 |
    |     10029 | 道格-迈克德莫特           |    1002 |
    |     10030 | 科里-约瑟夫               |    1002 |
    |     10031 | 阿龙-霍勒迪               |    1002 |
    |     10032 | TJ-利夫                   |    1002 |
    +-----------+---------------------------+---------+
    19 rows in set (0.00 sec)

__同理 NOT EXISTS 表示不存在的意思__

    SQL：SELECT player_id,player_name,team_id FROM player AS a WHERE NOT EXISTS (SELECT player_id FROM player_score AS b WHERE a.player_id=b.player_id  );

__out:__

    +-----------+------------------------------------+---------+
    | player_id | player_name                        | team_id |
    +-----------+------------------------------------+---------+
    |     10011 | 布雷克-格里芬                      |    1001 |
    |     10012 | 雷吉-巴洛克                        |    1001 |
    |     10013 | 卢克-肯纳德                        |    1001 |
    |     10014 | 斯坦利-约翰逊                      |    1001 |
    |     10015 | 亨利-埃伦森                        |    1001 |
    |     10016 | 凯里-托马斯                        |    1001 |
    |     10017 | 何塞-卡尔德隆                      |    1001 |
    |     10018 | 斯维亚托斯拉夫-米凯卢克            |    1001 |
    |     10019 | 扎克-洛夫顿                        |    1001 |
    |     10020 | 卡林-卢卡斯                        |    1001 |
    |     10021 | 维克多-奥拉迪波                    |    1002 |
    |     10026 | 达伦-科里森                        |    1002 |
    |     10027 | 韦斯利-马修斯                      |    1002 |
    |     10033 | 凯尔-奥奎因                        |    1002 |
    |     10034 | 埃德蒙-萨姆纳                      |    1002 |
    |     10035 | 达文-里德                          |    1002 |
    |     10036 | 阿利兹-约翰逊                      |    1002 |
    |     10037 | 伊凯·阿尼博古                      |    1002 |
    +-----------+------------------------------------+---------+
    18 rows in set (0.00 sec)


### 集合比较子查询

    IN      判断是否在集合中
    ANY     和比较操作符一起使用，与子查询返回的任何值做比较
    ALL     和比较操作符一起使用，与子查询返回的所有值做比较
    SOME    和ANY含义一致，是ANY的别名

假设我们想要看出场过的球员都有哪些，可以采用 __IN 子查询__ 来进行操作：(AS 在表名后为编辑表的别名)

    SQL: SELECT player_id,player_name,team_id FROM player AS a WHERE player_id IN (SELECT player_id FROM player_score AS b WHERE a.player_id=b.player_id  );

    or

    SQL: SELECT player_id,player_name,team_id FROM player AS a WHERE player_id IN (SELECT player_id FROM player_score);

__out：__

    +-----------+---------------------------+---------+
    | player_id | player_name               | team_id |
    +-----------+---------------------------+---------+
    |     10001 | 韦恩-艾灵顿               |    1001 |
    |     10002 | 雷吉-杰克逊               |    1001 |
    |     10003 | 安德烈-德拉蒙德           |    1001 |
    |     10004 | 索恩-马克                 |    1001 |
    |     10005 | 布鲁斯-布朗               |    1001 |
    |     10006 | 兰斯顿-加洛韦             |    1001 |
    |     10007 | 格伦-罗宾逊三世           |    1001 |
    |     10008 | 伊斯梅尔-史密斯           |    1001 |
    |     10009 | 扎扎-帕楚里亚             |    1001 |
    |     10010 | 乔恩-洛伊尔               |    1001 |
    |     10022 | 博扬-博格达诺维奇         |    1002 |
    |     10025 | 赛迪斯-杨                 |    1002 |
    |     10024 | 迈尔斯-特纳               |    1002 |
    |     10028 | 泰瑞克-埃文斯             |    1002 |
    |     10030 | 科里-约瑟夫               |    1002 |
    |     10023 | 多曼塔斯-萨博尼斯         |    1002 |
    |     10029 | 道格-迈克德莫特           |    1002 |
    |     10031 | 阿龙-霍勒迪               |    1002 |
    |     10032 | TJ-利夫                   |    1002 |
    +-----------+---------------------------+---------+
    19 rows in set (0.01 sec)


__ANY 和 ALL 子查询。__

__ANY 和 ALL 都需要使用比较符，比较符包括了（>）（=）（<）（>=）（<=）和（<>）等。__

如果我们想要查询球员表中，比印第安纳步行者（对应的 team_id 为 1002）中任何一个球员身高高的球员的信息，并且输出他们的球员 ID、球员姓名和球员身高，该怎么写呢？首先我们需要找出所有印第安纳步行者队中的球员身高，即SELECT height FROM player WHERE team_id = 1002，然后使用 ANY 子查询即：

    SQL: SELECT player_id,player_name,team_id FROM player WHERE height > ANY  (SELECT height FROM player WHERE team_id=1002);

__out:__

    +-----------+------------------------------------+---------+
    | player_id | player_name                        | team_id |
    +-----------+------------------------------------+---------+
    |     10001 | 韦恩-艾灵顿                        |    1001 |
    |     10002 | 雷吉-杰克逊                        |    1001 |
    |     10003 | 安德烈-德拉蒙德                    |    1001 |
    |     10004 | 索恩-马克                          |    1001 |
    |     10005 | 布鲁斯-布朗                        |    1001 |
    |     10006 | 兰斯顿-加洛韦                      |    1001 |
    |     10007 | 格伦-罗宾逊三世                    |    1001 |
    |     10009 | 扎扎-帕楚里亚                      |    1001 |
    |     10010 | 乔恩-洛伊尔                        |    1001 |
    |     10011 | 布雷克-格里芬                      |    1001 |
    |     10012 | 雷吉-巴洛克                        |    1001 |
    |     10013 | 卢克-肯纳德                        |    1001 |
    |     10014 | 斯坦利-约翰逊                      |    1001 |
    |     10015 | 亨利-埃伦森                        |    1001 |
    |     10016 | 凯里-托马斯                        |    1001 |
    |     10017 | 何塞-卡尔德隆                      |    1001 |
    |     10018 | 斯维亚托斯拉夫-米凯卢克            |    1001 |
    |     10019 | 扎克-洛夫顿                        |    1001 |
    |     10020 | 卡林-卢卡斯                        |    1001 |
    |     10021 | 维克多-奥拉迪波                    |    1002 |
    |     10022 | 博扬-博格达诺维奇                  |    1002 |
    |     10023 | 多曼塔斯-萨博尼斯                  |    1002 |
    |     10024 | 迈尔斯-特纳                        |    1002 |
    |     10025 | 赛迪斯-杨                          |    1002 |
    |     10027 | 韦斯利-马修斯                      |    1002 |
    |     10028 | 泰瑞克-埃文斯                      |    1002 |
    |     10029 | 道格-迈克德莫特                    |    1002 |
    |     10030 | 科里-约瑟夫                        |    1002 |
    |     10031 | 阿龙-霍勒迪                        |    1002 |
    |     10032 | TJ-利夫                            |    1002 |
    |     10033 | 凯尔-奥奎因                        |    1002 |
    |     10034 | 埃德蒙-萨姆纳                      |    1002 |
    |     10035 | 达文-里德                          |    1002 |
    |     10036 | 阿利兹-约翰逊                      |    1002 |
    |     10037 | 伊凯·阿尼博古                      |    1002 |
    +-----------+------------------------------------+---------+
    35 rows in set (0.00 sec)

如果我们想要查询球员表中，比印第安纳步行者（对应的 team_id 为 1002）中所有一个球员身高高的球员的信息，并且输出他们的球员 ID、球员姓名和球员身高，该怎么写呢？

    SQL: SELECT player_id,player_name,team_id FROM player WHERE height > ALL  (SELECT height FROM player WHERE team_id=1002);

__out:__

    +-----------+---------------+---------+
    | player_id | player_name   | team_id |
    +-----------+---------------+---------+
    |     10004 | 索恩-马克     |    1001 |
    +-----------+---------------+---------+
    1 row in set (0.00 sec)


### IN 和 EXISTS 的差别

__举个例子：现在我们有A,B两个表，我们使用下面语句进行查询：__

    SELECT * FROM A WHERE cc IN (SELECT cc FROM B)

    SELECT * FROM A WHERE EXIST (SELECT cc FROM B WHERE B.cc=A.cc)

__查询过程中，在我们对 cc 列建立索引的情况下，我们需要通过判断表 A 和表 B 的大小来判断IN 和 EXISTS的查询效率。__

现在我们将A表对应为player表，B表看成是我们的player_score表

    如果表 A 比表 B 大，那么 IN 子查询的效率要比 EXIST 子查询效率高，因为这时 B 表中如果对 cc 列进行了索引，那么 IN 子查询的效率就会比较高。

    同样，如果表 A 比表 B 小，那么使用 EXISTS 子查询效率会更高，因为我们可以使用到 A 表中对 cc 列的索引，而不用从 B 中进行 cc 列的查询。



### 将子查询作为计算字段

比如我想查询每个球队的球员数，也就是对应 team 这张表，我需要查询相同的 team_id 在 player 这张表中所有的球员数量是多少。

    SQL: SELECT team_id,team_name,(SELECT COUNT(*) FROM player WHERE player.team_id=team.team_id ) AS player_num FROM team; 

__out:__

    +---------+-----------------------+------------+
    | team_id | team_name             | player_num |
    +---------+-----------------------+------------+
    |    1001 | 底特律活塞            |         20 |
    |    1002 | 印第安纳步行者        |         17 |
    |    1003 | 亚特兰大老鹰          |          0 |
    +---------+-----------------------+------------+
    3 rows in set (0.00 sec)


__现在我们想得到场均得分大于 20 的球员。场均得分从 player_score 表中获取，同时你需要输出球员的 ID、球员姓名以及所在球队的 ID 信息。__

    EXISTS - SQL: SELECT player_id,player_name,team_id FROM player WHERE EXISTS (SELECT player_id FROM player_score WHERE player.player_id = player_score.player_id and score > 20 ) ;

    IN - SQL: SELECT  player_id,player_name,team_id FROM player WHERE player_id IN (SELECT player_id FROM player_score WHERE player.player_id = player_score.player_id and score > 20);

    JOIN - SQL: SELECT p.player_name,p.player_id,p.team_id,t.score from player AS p JOIN player_score AS t WHERE p.player_id = t.player_id and t.score >20;

__out：__

    +------------------+-----------+---------+-------+
    | player_name      | player_id | team_id | score |
    +------------------+-----------+---------+-------+
    | 韦恩-艾灵顿      |     10001 |    1001 |    26 |
    | 雷吉-杰克逊      |     10002 |    1001 |    22 |
    +------------------+-----------+---------+-------+
    2 rows in set (0.00 sec)

